@model TenantCore.Application.DTOs.TenantDto

@{
    ViewData["Title"] = "API Key Management";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">API Key Management</h1>
            <p class="text-secondary mb-0">Manage your tenant's API key for programmatic access</p>
        </div>
        @if (User.IsInRole("SuperAdmin"))
        {
            <a asp-controller="SuperAdmin" asp-action="Tenants" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Tenants
            </a>
        }
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Tenant Information Card -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card shadow">
                <div class="card-header py-3 bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-building me-2"></i>Tenant: @Model.Name (@Model.Domain)
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-0">
                        <strong>Status:</strong>
                        <span class="badge bg-@(Model.IsActive ? "success" : "danger")">
                            @(Model.IsActive ? "Active" : "Inactive")
                        </span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Card -->
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-key me-2"></i>API Key
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Important:</strong> Keep your API key secure and never share it publicly.
                        Use it in your application's server-side code to authenticate API requests.
                    </div>

                    <!-- API Key Display -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Current API Key</label>
                        <div class="input-group">
                            <input type="password"
                                   class="form-control font-monospace"
                                   id="apiKeyInput"
                                   value="@Model.ApiKey"
                                   readonly>
                            <button class="btn btn-outline-secondary"
                                    type="button"
                                    onclick="toggleApiKeyVisibility()"
                                    id="toggleButton">
                                <i class="fas fa-eye" id="toggleIcon"></i>
                            </button>
                            <button class="btn btn-outline-primary"
                                    type="button"
                                    onclick="copyApiKey()"
                                    id="copyButton">
                                <i class="fas fa-copy" id="copyIcon"></i> Copy
                            </button>
                        </div>
                        @if (Model.ApiKeyCreatedAt.HasValue)
                        {
                            <small class="text-muted">
                                Last regenerated: @Model.ApiKeyCreatedAt.Value.ToString("MMM dd, yyyy 'at' HH:mm UTC")
                            </small>
                        }
                    </div>

                    <!-- Regenerate API Key -->
                    <div class="mt-4">
                        <h6 class="fw-bold mb-3">Regenerate API Key</h6>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Warning:</strong> Regenerating your API key will immediately invalidate the current key.
                            Any applications using the old key will stop working until updated with the new key.
                        </div>

                        <form asp-action="RegenerateApiKey" asp-route-tenantId="@ViewBag.TenantId" method="post" onsubmit="return confirm('Are you sure you want to regenerate the API key? This will invalidate the current key immediately.');">
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-sync-alt me-2"></i>Regenerate API Key
                            </button>
                        </form>
                    </div>

                    <!-- API Usage Example -->
                    <div class="mt-5">
                        <h6 class="fw-bold mb-3">API Usage Example</h6>
                        <p>Use the following example to authenticate your API requests:</p>

                        <ul class="nav nav-tabs" id="exampleTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="curl-tab" data-bs-toggle="tab" data-bs-target="#curl" type="button">cURL</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="csharp-tab" data-bs-toggle="tab" data-bs-target="#csharp" type="button">C#</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="javascript-tab" data-bs-toggle="tab" data-bs-target="#javascript" type="button">JavaScript</button>
                            </li>
                        </ul>

                        <div class="tab-content mt-3" id="exampleTabsContent">
                            <div class="tab-pane fade show active" id="curl">
                                <pre class="bg-dark text-white p-3 rounded"><code>curl -X GET "https://api.yoursite.com/tenants/@Model.Id" \
  -H "X-API-Key: @Model.ApiKey"</code></pre>
                            </div>
                            <div class="tab-pane fade" id="csharp">
                                <pre class="bg-dark text-white p-3 rounded"><code>using var client = new HttpClient();
client.DefaultRequestHeaders.Add("X-API-Key", "@Model.ApiKey");
var response = await client.GetAsync("https://api.yoursite.com/tenants/@Model.Id");
var content = await response.Content.ReadAsStringAsync();</code></pre>
                            </div>
                            <div class="tab-pane fade" id="javascript">
                                <pre class="bg-dark text-white p-3 rounded"><code>fetch('https://api.yoursite.com/tenants/@Model.Id', {
  headers: {
    'X-API-Key': '@Model.ApiKey'
  }
})
.then(response => response.json())
.then(data => console.log(data));</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script>
        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKeyInput');
            const icon = document.getElementById('toggleIcon');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function copyApiKey() {
            const input = document.getElementById('apiKeyInput');
            const button = document.getElementById('copyButton');
            const icon = document.getElementById('copyIcon');

            // Create a temporary input to copy from
            const temp = document.createElement('input');
            temp.value = input.value;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);

            // Show feedback
            icon.classList.remove('fa-copy');
            icon.classList.add('fa-check');
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-success');
            button.innerHTML = '<i class="fas fa-check"></i> Copied!';

            // Reset after 2 seconds
            setTimeout(() => {
                icon.classList.remove('fa-check');
                icon.classList.add('fa-copy');
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-primary');
                button.innerHTML = '<i class="fas fa-copy" id="copyIcon"></i> Copy';
            }, 2000);
        }
    </script>
}
